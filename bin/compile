#!/usr/bin/env bash

set -e

git clone https://github.com/sstephenson/rbenv.git /app/.rbenv

mkdir -p /app/.profile.d
echo 'export PATH="/app/.rbenv/bin:$PATH"' >> /app/.profile.d/rbenv
echo 'eval "$(rbenv init -)"' >> /app/.profile.d/rbenv
. /app/.profile.d/rbenv

git clone https://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build

apt-get install autoconf bison build-essential libssl-dev zlib1g zlib1g-dev

[ -f /app/.ruby-version ] && rbenv install $(cat /app/.ruby-version)

ruby_version=$(grep -e '^ruby ' | sed -e 's/^ruby //') || true
[ -z $ruby_version ] || rbenv install $ruby_version

[ -f /app/Gemfile ] && (
  . /app/.profile.d/rbenv
  rbenv rehash
  gem install bundler
  cd /app
  bundle install
)

